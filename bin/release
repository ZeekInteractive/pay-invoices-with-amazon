#! /bin/bash

# Usage, from project root:
# 	bin/release 1.0
#
# Requires:
# 	gh auth login
# 	git checkout main && bin/tag 1.0 'Initial release.' && bin/package

OSNAME="$(uname -s)"
if [[ "$OSNAME" = "Darwin" ]] # Darwin, Mac, Cygwin, MinGw, Git, etc.
then
	# Mac: Install https://brew.sh and composer if not available.
	if ! command -v brew &> /dev/null
	then
		/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
	fi
	if ! command -v gh &> /dev/null
	then
		brew install gh
	fi
fi;

tag=$1
zip_name="piwa.zip"
release_title=$(git cat-file -p "$tag" | sed '1,/^$/d')
release_description="[Changelog](https://github.com/ZeekInteractive/piwa/commits/$tag)"

if [[ "release not found" == $( gh release view "$tag" 2>&1 ) ]]; then
	# The release does not exist. Create it.
	gh release create "$tag" -t "$release_title" -n "$release_description" "$zip_name"
else
	# The release exists. Edit it.
	gh release edit "$tag" -t "$release_title" -n "$release_description"
	gh release upload "$tag" "$zip_name" --clobber
fi

# Open the release in a web browser.
gh release view "$tag" -w
